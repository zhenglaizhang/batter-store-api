{% extends "admin/base.html" %}

{% block title %}ç”µæ± è®¢å•ç®¡ç† - ç”µæ± å›æ”¶ç®¡ç†åå°{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 24px;
    }
    .page-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
    }
    .stats-row {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        flex: 1;
        padding: 16px;
        background: #f5f5f5;
        border-radius: 4px;
    }
    .stat-title {
        color: #666;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: 600;
    }
    .table-container {
        background: #fff;
        border-radius: 4px;
    }
    .status-tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 12px;
    }
    .status-pending { background: #fff7e6; color: #faad14; border: 1px solid #ffd591; }
    .status-processing { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }
    .status-completed { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .status-cancelled { background: #fff1f0; color: #f5222d; border: 1px solid #ffccc7; }
    .modal-content {
        padding: 24px;
    }
    .info-row {
        display: flex;
        margin-bottom: 16px;
    }
    .info-label {
        width: 120px;
        color: #666;
        font-weight: 500;
    }
    .info-value {
        flex: 1;
        color: #333;
    }
    .photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 16px;
    }
    .photo-card {
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        overflow: hidden;
    }
    .photo-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f5f5f5;
    }
    .photo-info {
        padding: 8px;
        font-size: 12px;
        color: #666;
    }
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-primary {
        background: #1890ff;
        color: #fff;
    }
    .btn-primary:hover {
        background: #40a9ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ç”µæ± ä¸Šä¼ è®¢å•ç®¡ç†</h1>
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-title">æ€»è®¢å•æ•°</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">æ€»ç…§ç‰‡æ•°</div>
            <div class="stat-value" id="stat-photos">0</div>
        </div>
    </div>
    <button class="btn btn-primary" onclick="loadOrders()" id="refresh-btn">åˆ·æ–°</button>
</div>

<div class="table-container">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #fafafa; border-bottom: 1px solid #e8e8e8;">
                <th style="padding: 12px; text-align: left; font-weight: 600;">è®¢å•ID</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">åº—é“ºåç§°</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">è”ç³»äºº</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">è”ç³»ç”µè¯</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">ç…§ç‰‡æ•°é‡</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">çŠ¶æ€</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">åˆ›å»ºæ—¶é—´</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="orders-table-body">
            <tr>
                <td colspan="8" style="padding: 40px; text-align: center; color: #999;">åŠ è½½ä¸­...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 1000px; margin: 40px auto; background: #fff; border-radius: 8px;">
        <div style="padding: 16px 24px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 18px;">è®¢å•è¯¦æƒ…</h2>
            <button onclick="closeDetailModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
        <div class="modal-content">
            <div id="order-detail-info"></div>
            <div id="order-photos"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentOrder = null;

// åŠ è½½è®¢å•åˆ—è¡¨
async function loadOrders() {
    console.log('loadOrders å‡½æ•°è¢«è°ƒç”¨');
    const tbody = document.getElementById('orders-table-body');
    const refreshBtn = document.getElementById('refresh-btn');
    
    if (!tbody) {
        console.error('æ‰¾ä¸åˆ° orders-table-body å…ƒç´ ');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #999;">åŠ è½½ä¸­...</td></tr>';
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'åŠ è½½ä¸­...';
    }
    
    const token = getToken();
    console.log('Token:', token ? token.substring(0, 20) + '...' : 'æœªæ‰¾åˆ°');
    const apiUrl = `${API_BASE}/api/battery/orders`;
    console.log('API URL:', apiUrl);
    
    try {
        const response = await axios.get(apiUrl, {
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        
        console.log('è®¢å•åˆ—è¡¨å“åº”:', response);
        console.log('å“åº”æ•°æ®:', response.data);
        
        // æ£€æŸ¥å“åº”æ ¼å¼ï¼šcode === 200 æˆ– success === true
        if (response.data && (response.data.code === 200 || response.data.success === true) && response.data.data) {
            const orders = response.data.data || [];
            console.log('è®¢å•æ•°é‡:', orders.length);
            renderOrders(orders);
            updateStats(orders);
        } else {
            console.error('å“åº”æ ¼å¼ä¸æ­£ç¡®:', response.data);
            throw new Error(response.data?.message || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', error.response);
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="8" style="padding: 40px; text-align: center; color: #f5222d;">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
        alert('åŠ è½½ç”µæ± è®¢å•å¤±è´¥: ' + (error.response?.data?.message || error.message));
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = 'åˆ·æ–°';
        }
    }
}

// æ¸²æŸ“è®¢å•åˆ—è¡¨
function renderOrders(orders) {
    const tbody = document.getElementById('orders-table-body');
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.map(order => `
        <tr style="border-bottom: 1px solid #e8e8e8;">
            <td style="padding: 12px;"><code style="font-size: 12px;">${order.order_id.substring(0, 8)}...</code></td>
            <td style="padding: 12px;">${order.store_name}</td>
            <td style="padding: 12px;">${order.contact_name}</td>
            <td style="padding: 12px;">${order.contact_phone}</td>
            <td style="padding: 12px;">ğŸ“· ${order.total_photos}</td>
            <td style="padding: 12px;">${getStatusTag(order.status)}</td>
            <td style="padding: 12px;">${formatDate(order.created_at)}</td>
            <td style="padding: 12px;">
                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="showOrderDetail('${order.order_id}')">æŸ¥çœ‹è¯¦æƒ…</button>
            </td>
        </tr>
    `).join('');
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats(orders) {
    const total = orders.length;
    const totalPhotos = orders.reduce((sum, order) => sum + (order.total_photos || 0), 0);
    
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-photos').textContent = totalPhotos;
}

// è·å–çŠ¶æ€æ ‡ç­¾
function getStatusTag(status) {
    const config = {
        pending: { class: 'status-pending', text: 'å¾…å¤„ç†' },
        processing: { class: 'status-processing', text: 'å¤„ç†ä¸­' },
        completed: { class: 'status-completed', text: 'å·²å®Œæˆ' },
        cancelled: { class: 'status-cancelled', text: 'å·²å–æ¶ˆ' }
    };
    const cfg = config[status] || { class: '', text: status };
    return `<span class="status-tag ${cfg.class}">${cfg.text}</span>`;
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN');
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ˜¾ç¤ºè®¢å•è¯¦æƒ…
async function showOrderDetail(orderId) {
    try {
        const response = await axios.get(`${API_BASE}/api/battery/orders/${orderId}`, {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        // æ£€æŸ¥å“åº”æ ¼å¼ï¼šcode === 200 æˆ– success === true
        if (response.data && (response.data.code === 200 || response.data.success === true) && response.data.data) {
            const order = response.data.data;
            currentOrder = order;
            
            // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
            const infoHtml = `
                <div style="margin-bottom: 24px; padding: 16px; background: #f5f5f5; border-radius: 4px;">
                    <div class="info-row"><div class="info-label">è®¢å•ID:</div><div class="info-value"><code>${order.order_id}</code></div></div>
                    <div class="info-row"><div class="info-label">ç”¨æˆ·ID:</div><div class="info-value"><code>${order.user_id}</code></div></div>
                    <div class="info-row"><div class="info-label">çŠ¶æ€:</div><div class="info-value">${getStatusTag(order.status)}</div></div>
                    <div class="info-row"><div class="info-label">åº—é“ºåç§°:</div><div class="info-value">${order.store_name}</div></div>
                    <div class="info-row"><div class="info-label">è”ç³»äºº:</div><div class="info-value">${order.contact_name}</div></div>
                    <div class="info-row"><div class="info-label">è”ç³»ç”µè¯:</div><div class="info-value">${order.contact_phone}</div></div>
                    <div class="info-row"><div class="info-label">è”ç³»åœ°å€:</div><div class="info-value">${order.contact_address}</div></div>
                    <div class="info-row"><div class="info-label">ç…§ç‰‡æ•°é‡:</div><div class="info-value">${order.total_photos}</div></div>
                    <div class="info-row"><div class="info-label">åˆ›å»ºæ—¶é—´:</div><div class="info-value">${formatDate(order.created_at)}</div></div>
                </div>
            `;
            document.getElementById('order-detail-info').innerHTML = infoHtml;
            
            // æ˜¾ç¤ºç…§ç‰‡
            if (order.photos && order.photos.length > 0) {
                const photosHtml = `
                    <h3 style="margin-top: 24px; margin-bottom: 16px;">ä¸Šä¼ ç…§ç‰‡</h3>
                    <div class="photo-grid">
                        ${order.photos.map(photo => {
                            // ä¼˜å…ˆä½¿ç”¨ download_urlï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•æ‹¼æ¥ file_path
                            const imageUrl = photo.download_url || (photo.file_path ? `${API_BASE}/${photo.file_path}` : '');
                            return `
                            <div class="photo-card">
                                <img 
                                    src="${imageUrl}" 
                                    alt="${photo.original_filename}"
                                    class="photo-image"
                                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23f5f5f5%22 width=%22200%22 height=%22200%22/%3E%3Ctext fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2214%22 dy=%2210.5%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3Eå›¾ç‰‡åŠ è½½å¤±è´¥%3C/text%3E%3C/svg%3E'"
                                />
                                <div class="photo-info">
                                    <div>${photo.original_filename}</div>
                                    <div style="color: #999; margin-top: 4px;">${formatFileSize(photo.file_size)}</div>
                                    <div style="color: #999; margin-top: 4px;">${formatDate(photo.created_at)}</div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
                document.getElementById('order-photos').innerHTML = photosHtml;
            } else {
                document.getElementById('order-photos').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“·</div>
                        <div>æš‚æ— ç…§ç‰‡</div>
                    </div>
                `;
            }
            
            document.getElementById('detail-modal').style.display = 'block';
        } else {
            throw new Error(response.data.message || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        alert('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥: ' + (error.response?.data?.message || error.message));
    }
}

// å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
function closeDetailModal() {
    document.getElementById('detail-modal').style.display = 'none';
    currentOrder = null;
}

// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
(function() {
    console.log('è®¢å•è·Ÿè¸ªé¡µé¢è„šæœ¬å¼€å§‹æ‰§è¡Œ');
    console.log('API_BASE:', typeof API_BASE !== 'undefined' ? API_BASE : 'æœªå®šä¹‰');
    console.log('getToken:', typeof getToken !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
    console.log('axios:', typeof axios !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
    console.log('loadOrders:', typeof loadOrders !== 'undefined' ? 'å·²å®šä¹‰' : 'æœªå®šä¹‰');
    
    // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
    function initLoadOrders() {
        if (typeof API_BASE === 'undefined') {
            console.error('API_BASE æœªå®šä¹‰ï¼Œç­‰å¾…...');
            setTimeout(initLoadOrders, 100);
            return;
        }
        if (typeof getToken === 'undefined') {
            console.error('getToken æœªå®šä¹‰ï¼Œç­‰å¾…...');
            setTimeout(initLoadOrders, 100);
            return;
        }
        if (typeof axios === 'undefined') {
            console.error('axios æœªå®šä¹‰ï¼Œç­‰å¾…...');
            setTimeout(initLoadOrders, 100);
            return;
        }
        if (typeof loadOrders === 'undefined') {
            console.error('loadOrders æœªå®šä¹‰');
            return;
        }
        
        console.log('æ‰€æœ‰ä¾èµ–å·²å°±ç»ªï¼Œå¼€å§‹åŠ è½½è®¢å•æ•°æ®');
        loadOrders();
    }
    
    // å¦‚æœ DOM å·²åŠ è½½ï¼Œç«‹å³æ‰§è¡Œï¼›å¦åˆ™ç­‰å¾…
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initLoadOrders, 300);
        });
    } else {
        setTimeout(initLoadOrders, 300);
    }
})();
</script>
{% endblock %}

