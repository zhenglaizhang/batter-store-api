{% extends "admin/base.html" %}

{% block title %}用户注册管理 - 电池回收管理后台{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 24px;
    }
    .page-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
    }
    .stats-row {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
    }
    .stat-card {
        flex: 1;
        padding: 16px;
        background: #f5f5f5;
        border-radius: 4px;
    }
    .stat-title {
        color: #666;
        font-size: 14px;
        margin-bottom: 8px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: 600;
    }
    .stat-value.pending { color: #faad14; }
    .stat-value.approved { color: #52c41a; }
    .stat-value.rejected { color: #f5222d; }
    .table-container {
        background: #fff;
        border-radius: 4px;
    }
    .status-tag {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 12px;
    }
    .status-pending { background: #fff7e6; color: #faad14; border: 1px solid #ffd591; }
    .status-approved { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .status-rejected { background: #fff1f0; color: #f5222d; border: 1px solid #ffccc7; }
    .modal-content {
        padding: 24px;
    }
    .info-row {
        display: flex;
        margin-bottom: 16px;
    }
    .info-label {
        width: 120px;
        color: #666;
        font-weight: 500;
    }
    .info-value {
        flex: 1;
        color: #333;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }
    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }
    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-primary {
        background: #1890ff;
        color: #fff;
    }
    .btn-primary:hover {
        background: #40a9ff;
    }
    .btn-default {
        background: #fff;
        color: #333;
        border: 1px solid #d9d9d9;
    }
    .btn-default:hover {
        background: #fafafa;
    }
    .btn-group {
        display: flex;
        gap: 8px;
        margin-top: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">用户注册管理</h1>
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-title">总注册数</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">待审核</div>
            <div class="stat-value pending" id="stat-pending">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">已通过</div>
            <div class="stat-value approved" id="stat-approved">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">已拒绝</div>
            <div class="stat-value rejected" id="stat-rejected">0</div>
        </div>
    </div>
    <button class="btn btn-primary" onclick="loadRegistrations()" id="refresh-btn">刷新</button>
</div>

<div class="table-container">
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #fafafa; border-bottom: 1px solid #e8e8e8;">
                <th style="padding: 12px; text-align: left; font-weight: 600;">注册ID</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">店铺名称</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">联系人</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">联系电话</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">业务类型</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">用户角色</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">状态</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">提交时间</th>
                <th style="padding: 12px; text-align: left; font-weight: 600;">操作</th>
            </tr>
        </thead>
        <tbody id="registrations-table-body">
            <tr>
                <td colspan="9" style="padding: 40px; text-align: center; color: #999;">加载中...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 审核模态框 -->
<div id="review-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px;">
        <div style="padding: 16px 24px; border-bottom: 1px solid #e8e8e8; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 18px;">审核用户注册</h2>
            <button onclick="closeReviewModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
        </div>
        <div class="modal-content">
            <div id="review-user-info"></div>
            <form id="review-form" onsubmit="handleStatusUpdate(event)">
                <div class="form-group">
                    <label class="form-label">审核状态</label>
                    <select class="form-select" id="review-status" name="status" required>
                        <option value="pending">待审核</option>
                        <option value="approved">通过</option>
                        <option value="rejected">拒绝</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">审核备注</label>
                    <textarea class="form-textarea" id="review-comment" name="review_comment" placeholder="请输入审核备注（可选）"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">更新状态</button>
                    <button type="button" class="btn btn-default" onclick="closeReviewModal()">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentRegistration = null;

// 加载注册列表
async function loadRegistrations() {
    const tbody = document.getElementById('registrations-table-body');
    const refreshBtn = document.getElementById('refresh-btn');
    
    tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: #999;">加载中...</td></tr>';
    refreshBtn.disabled = true;
    refreshBtn.textContent = '加载中...';
    
    try {
        const response = await axios.get(`${API_BASE}/api/user/registrations`, {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        console.log('用户注册列表响应:', response.data); // 调试用
        
        // 检查响应格式：code === 200 或 success === true
        if (response.data && (response.data.code === 200 || response.data.success === true) && response.data.data) {
            const registrations = response.data.data || [];
            renderRegistrations(registrations);
            updateStats(registrations);
        } else {
            throw new Error(response.data.message || '加载失败');
        }
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="9" style="padding: 40px; text-align: center; color: #f5222d;">加载失败: ${error.message}</td></tr>`;
        alert('加载用户注册记录失败: ' + (error.response?.data?.message || error.message));
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = '刷新';
    }
}

// 渲染注册列表
function renderRegistrations(registrations) {
    const tbody = document.getElementById('registrations-table-body');
    
    if (registrations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: #999;">暂无数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = registrations.map(reg => `
        <tr style="border-bottom: 1px solid #e8e8e8;">
            <td style="padding: 12px;">${reg.registration_id}</td>
            <td style="padding: 12px;">${reg.store_name}</td>
            <td style="padding: 12px;">${reg.contact_name}</td>
            <td style="padding: 12px;">${reg.contact_phone}</td>
            <td style="padding: 12px;">${reg.business_type_name}</td>
            <td style="padding: 12px;">${reg.user_role_name}</td>
            <td style="padding: 12px;">${getStatusTag(reg.status)}</td>
            <td style="padding: 12px;">${formatDate(reg.submit_time)}</td>
            <td style="padding: 12px;">
                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="showReviewModal('${reg.registration_id}')">审核</button>
            </td>
        </tr>
    `).join('');
}

// 更新统计信息
function updateStats(registrations) {
    const stats = {
        total: registrations.length,
        pending: registrations.filter(r => r.status === 'pending').length,
        approved: registrations.filter(r => r.status === 'approved').length,
        rejected: registrations.filter(r => r.status === 'rejected').length
    };
    
    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-pending').textContent = stats.pending;
    document.getElementById('stat-approved').textContent = stats.approved;
    document.getElementById('stat-rejected').textContent = stats.rejected;
}

// 获取状态标签
function getStatusTag(status) {
    const config = {
        pending: { class: 'status-pending', text: '待审核' },
        approved: { class: 'status-approved', text: '已通过' },
        rejected: { class: 'status-rejected', text: '已拒绝' }
    };
    const cfg = config[status] || { class: '', text: status };
    return `<span class="status-tag ${cfg.class}">${cfg.text}</span>`;
}

// 格式化日期
function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleString('zh-CN');
}

// 显示审核模态框
async function showReviewModal(registrationId) {
    try {
        const response = await axios.get(`${API_BASE}/api/user/registrations`, {
            headers: {
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        // 检查响应格式：code === 200 或 success === true
        if (response.data && (response.data.code === 200 || response.data.success === true) && response.data.data) {
            const registrations = response.data.data || [];
            const reg = registrations.find(r => r.registration_id === registrationId);
            
            if (reg) {
                currentRegistration = reg;
                document.getElementById('review-status').value = reg.status;
                document.getElementById('review-comment').value = reg.review_comment || '';
                
                // 显示用户信息
                const infoHtml = `
                    <div style="margin-bottom: 24px; padding: 16px; background: #f5f5f5; border-radius: 4px;">
                        <div class="info-row"><div class="info-label">注册ID:</div><div class="info-value">${reg.registration_id}</div></div>
                        <div class="info-row"><div class="info-label">店铺名称:</div><div class="info-value">${reg.store_name}</div></div>
                        <div class="info-row"><div class="info-label">联系人:</div><div class="info-value">${reg.contact_name}</div></div>
                        <div class="info-row"><div class="info-label">联系电话:</div><div class="info-value">${reg.contact_phone}</div></div>
                        <div class="info-row"><div class="info-label">地址:</div><div class="info-value">${reg.address}</div></div>
                        <div class="info-row"><div class="info-label">业务类型:</div><div class="info-value">${reg.business_type_name}</div></div>
                        <div class="info-row"><div class="info-label">用户角色:</div><div class="info-value">${reg.user_role_name}</div></div>
                        <div class="info-row"><div class="info-label">当前状态:</div><div class="info-value">${getStatusTag(reg.status)}</div></div>
                        <div class="info-row"><div class="info-label">提交时间:</div><div class="info-value">${formatDate(reg.submit_time)}</div></div>
                        ${reg.review_time ? `<div class="info-row"><div class="info-label">审核时间:</div><div class="info-value">${formatDate(reg.review_time)}</div></div>` : ''}
                        ${reg.business_license_path ? `<div class="info-row"><div class="info-label">营业执照:</div><div class="info-value"><a href="${API_BASE}/${reg.business_license_path}" target="_blank">查看</a></div></div>` : ''}
                    </div>
                `;
                document.getElementById('review-user-info').innerHTML = infoHtml;
                document.getElementById('review-modal').style.display = 'block';
            }
        }
    } catch (error) {
        alert('加载用户信息失败: ' + (error.response?.data?.message || error.message));
    }
}

// 关闭审核模态框
function closeReviewModal() {
    document.getElementById('review-modal').style.display = 'none';
    currentRegistration = null;
    document.getElementById('review-form').reset();
}

// 处理状态更新
async function handleStatusUpdate(event) {
    event.preventDefault();
    
    if (!currentRegistration) return;
    
    const status = document.getElementById('review-status').value;
    const reviewComment = document.getElementById('review-comment').value;
    
    try {
        const response = await axios.put(
            `${API_BASE}/api/user/registrations/${currentRegistration.registration_id}/status`,
            {
                status: status,
                review_comment: reviewComment
            },
            {
                headers: {
                    'Authorization': 'Bearer ' + getToken()
                }
            }
        );
        
        // 检查响应格式：code === 200 或 success === true
        if (response.data && (response.data.code === 200 || response.data.success === true)) {
            alert('状态更新成功');
            closeReviewModal();
            loadRegistrations();
        } else {
            throw new Error(response.data.message || '更新失败');
        }
    } catch (error) {
        alert('状态更新失败: ' + (error.response?.data?.message || error.message));
    }
}

// 页面加载时获取数据
// 使用 DOMContentLoaded 确保 DOM 已加载，延迟执行确保 base.html 中的脚本已执行
document.addEventListener('DOMContentLoaded', function() {
    // 延迟一点执行，确保 base.html 中的脚本已执行
    setTimeout(function() {
        console.log('开始加载用户注册数据');
        if (typeof loadRegistrations === 'function') {
            loadRegistrations();
        } else {
            console.error('loadRegistrations 函数未定义');
        }
    }, 200);
});
</script>
{% endblock %}

